<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Корзина — Bloody</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root{
        --primary: #e30707;
        --bg: #f7f7f8;
        --card: #fff;
        --muted: #6c757d;
        --radius: 12px;
        --shadow: 0 10px 30px rgba(0,0,0,0.08);
        --green: #28a745;
    }
    body{
        background: var(--bg);
        font-family: Inter, system-ui, -apple-system, sans-serif;
        margin:0;
    }
    .navbar{ background: #222; }
    .navbar-brand { color: var(--primary) !important; font-weight:700; }
    
    /* Стили уведомления */
    .bloody-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--green);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        z-index: 10000;
        transform: translateX(150%);
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-weight: 600;
    }
    .bloody-toast.show { transform: translateX(0); }

    .page-header{
        max-width:1100px;
        margin:36px auto 10px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:0 16px;
    }
    .cart-wrap{ max-width:1100px; margin: 0 auto 80px; padding: 20px; }
    .cart-panel{ display:grid; grid-template-columns: 1fr 360px; gap:24px; }
    .items { background: var(--card); border-radius: var(--radius); padding:18px; box-shadow: var(--shadow); }
    .summary { background: var(--card); border-radius: var(--radius); padding:18px; box-shadow: var(--shadow); height: fit-content; }
    
    .cart-item{
        display:flex; gap:12px; align-items:center; padding:12px 0; border-bottom:1px solid #eee;
    }
    .thumb{
        width:90px; height:70px; background:#f0f0f0; border-radius:8px; overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .item-info{ flex:1; }
    .item-name{ font-weight:600; }
    .item-price{ color:var(--primary); font-weight:700; }
    
    .checkout-btn{
                background:var(--primary); color:#fff; border:none; width:100%; padding:14px;
        border-radius:10px; font-weight:700; transition: 0.3s;
    }
    .checkout-btn:hover { opacity: 0.9; transform: translateY(-2px); }
    
    .empty-state{ text-align:center; padding:40px; color:var(--muted); }
    .wallet-img { width: 20px; margin-right: 5px; filter: invert(1); }
</style>
</head>
<body>

<!-- Контейнер для уведомлений -->
<div id="toastContainer"></div>

<nav class="navbar navbar-expand-lg">
  <div class="container-fluid" style="max-width:1100px;margin:0 auto;">
    <a class="navbar-brand" href="index.html"><i class="fas fa-gem"></i> Bloody</a>
    <div class="ms-auto d-flex align-items-center gap-3">
        <a href="index.html" class="btn btn-outline-light btn-sm">На главную</a>
        <div class="balance-container">
            <div class="btn btn-outline-light btn-sm">
                <img src="wallet2.svg" class="wallet-img">
                <span id="balanceHead">0₽</span>
            </div>
        </div>
    </div>
  </div>
</nav>

<header class="page-header">
    <h1 style="margin:0;font-size:1.6rem;color:#111;">Ваша корзина</h1>
</header>

<main class="cart-wrap">
    <div class="cart-panel">
        <div class="items" id="itemsPanel">
            <!-- Список товаров загрузится через JS -->
        </div>
        <aside class="summary">
            <h4 style="margin-top:0;">Итог заказа</h4>
            <div class="d-flex justify-content-between mb-2"><span>Товары</span><strong id="summary-count">0</strong></div>
            <div class="d-flex justify-content-between mb-3"><span>Сумма</span><strong id="summary-total">0₽</strong></div>
            <hr>
            <div class="mb-3">
                <label class="form-label">Ваш email</label>
                <input id="emailInput" type="email" class="form-control" placeholder="example@mail.ru">
            </div>
            <button id="checkoutBtn" class="checkout-btn">ОПЛАТИТЬ ЗАКАЗ</button>
        </aside>
    </div>
</main>

<script>
// --- СИСТЕМА УВЕДОМЛЕНИЙ ---
function showToast(message) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = 'bloody-toast';
    toast.innerHTML = `<i class="fas fa-check-circle"></i> <span>${message}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 400);
    }, 3500);
}

function formatCurrency(n){ return Number(n).toLocaleString('ru-RU') + '₽'; }

// Получаем данные пользователя
function getUser() {
    return JSON.parse(localStorage.getItem('bloody_user')) || { balance: 0, inventory: [] };
}

function updateUI() {
    const user = getUser();
    document.getElementById('balanceHead').textContent = formatCurrency(user.balance);
    renderCart();
}

function renderCart() {
    const container = document.getElementById('itemsPanel');
    const cart = JSON.parse(localStorage.getItem('cart') || "[]");
    
    if(cart.length === 0) {
        container.innerHTML = '<div class="empty-state"><h4>Корзина пуста</h4><a href="index.html" class="btn btn-sm btn-danger mt-2">К покупкам</a></div>';
        document.getElementById('summary-total').textContent = '0₽';
        document.getElementById('summary-count').textContent = '0';
        return;
    }

    container.innerHTML = cart.map((item, idx) => `
        <div class="cart-item">
            <div class="thumb"><img src="${item.image || 'box.png'}"></div>
            <div class 
="item-info">
                <div class="item-name">${item.name}</div>
                <div class="item-price">${formatCurrency(item.price)}</div>
            </div>
            <button class="btn text-danger" onclick="removeFromCart(${idx})"><i class="fa fa-trash"></i></button>
        </div>
    `).join('');

    const total = cart.reduce((s, i) => s + Number(i.price), 0);
    document.getElementById('summary-total').textContent = formatCurrency(total);
    document.getElementById('summary-count').textContent = cart.length;
}

function removeFromCart(idx) {
    let cart = JSON.parse(localStorage.getItem('cart') || "[]");
    cart.splice(idx, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderCart();
}

// --- ОФОРМЛЕНИЕ ЗАКАЗА ---
document.getElementById('checkoutBtn').addEventListener('click', function() {
    const cart = JSON.parse(localStorage.getItem('cart') || "[]");
    let user = getUser();
    
    if(cart.length === 0) {
        alert("Ваша корзина пуста!");
        return;
    }

    const total = cart.reduce((s, i) => s + Number(i.price), 0);

    if(user.balance < total) {
        alert(`Недостаточно средств! Вам не хватает ${formatCurrency(total - user.balance)}`);
        return;
    }

    if(confirm(`Списать ${formatCurrency(total)} и оформить заказ?`)) {
        // 1. Списываем баланс
        user.balance -= total;
        
        // 2. Добавляем товары в инвентарь профиля
        cart.forEach(item => {
            user.inventory.push({
                id: item.id,
                name: item.name,
                price: item.price,
                img: item.image,
                date: new Date().toLocaleDateString()
            });
        });

        // 3. Сохраняем обновленного пользователя
        localStorage.setItem('bloody_user', JSON.stringify(user));
        
        // 4. Очищаем корзину
        localStorage.removeItem('cart');

        // 5. Показываем КРАСИВОЕ уведомление
        showToast(`Успешно! Списано ${formatCurrency(total)}. Товары уже в инвентаре!`);
        
        // 6. Обновляем интерфейс
        updateUI();
    }
});

document.addEventListener('DOMContentLoaded', updateUI);
</script>

</body>
</html>